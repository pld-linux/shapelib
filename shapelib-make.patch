--- shapelib-1.3.0/Makefile.orig	2011-07-24 06:32:26.000000000 +0200
+++ shapelib-1.3.0/Makefile	2012-04-13 18:55:30.562909803 +0200
@@ -3,6 +3,8 @@
 CFLAGS	=	-g -Wall -fPIC
 #CFLAGS  =       -g -DUSE_CPL
 #CC = g++
+libdir	=	/usr/local/lib
+includedir	=	/usr/local/include
 
 LIBOBJ	=	shpopen.o dbfopen.o safileio.o shptree.o 
 SHPBIN	=	shpcreate shpadd shpdump shprewind dbfcreate dbfadd dbfdump \
@@ -24,35 +26,35 @@
 safileio.o:	safileio.c shapefil.h
 	$(CC) $(CFLAGS) -c safileio.c
 
-shpcreate:	shpcreate.c shpopen.o safileio.o 
-	$(CC) $(CFLAGS) shpcreate.c shpopen.o safileio.o $(LINKOPT) -o shpcreate
+shpcreate:	shpcreate.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shpcreate.c libshp.la $(LINKOPT) -o shpcreate
 
-shpadd:		shpadd.c shpopen.o safileio.o
-	$(CC) $(CFLAGS) shpadd.c shpopen.o safileio.o $(LINKOPT) -o shpadd
+shpadd:		shpadd.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shpadd.c libshp.la $(LINKOPT) -o shpadd
 
-shpdump:	shpdump.c shpopen.o safileio.o
-	$(CC) $(CFLAGS) shpdump.c shpopen.o safileio.o $(LINKOPT) -o shpdump
+shpdump:	shpdump.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shpdump.c libshp.la $(LINKOPT) -o shpdump
 
-shprewind:	shprewind.c shpopen.o safileio.o
-	$(CC) $(CFLAGS) shprewind.c shpopen.o safileio.o $(LINKOPT) -o shprewind
+shprewind:	shprewind.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shprewind.c libshp.la $(LINKOPT) -o shprewind
 
-dbfcreate:	dbfcreate.c dbfopen.o safileio.o
-	$(CC) $(CFLAGS) dbfcreate.c dbfopen.o safileio.o $(LINKOPT) -o dbfcreate
+dbfcreate:	dbfcreate.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) dbfcreate.c libshp.la $(LINKOPT) -o dbfcreate
 
-dbfadd:		dbfadd.c dbfopen.o safileio.o
-	$(CC) $(CFLAGS) dbfadd.c dbfopen.o safileio.o $(LINKOPT) -o dbfadd
+dbfadd:		dbfadd.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) dbfadd.c libshp.la $(LINKOPT) -o dbfadd
 
-dbfdump:	dbfdump.c dbfopen.o safileio.o
-	$(CC) $(CFLAGS) dbfdump.c dbfopen.o safileio.o $(LINKOPT) -o dbfdump
+dbfdump:	dbfdump.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) dbfdump.c libshp.la $(LINKOPT) -o dbfdump
 
-shptest:	shptest.c shpopen.o safileio.o
-	$(CC) $(CFLAGS) shptest.c shpopen.o safileio.o $(LINKOPT) -o shptest
+shptest:	shptest.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shptest.c libshp.la $(LINKOPT) -o shptest
 
-shputils:	shputils.c shpopen.o safileio.o dbfopen.o 
-	$(CC) $(CFLAGS) shputils.c shpopen.o safileio.o dbfopen.o  $(LINKOPT) -o shputils
+shputils:	shputils.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shputils.c libshp.la  $(LINKOPT) -o shputils
 
-shptreedump:	shptreedump.c shptree.o shpopen.o safileio.o
-	$(CC) $(CFLAGS) shptreedump.c shptree.o shpopen.o safileio.o $(LINKOPT) \
+shptreedump:	shptreedump.c libshp.la
+	libtool --mode=link $(CC) $(CFLAGS) shptreedump.c libshp.la $(LINKOPT) \
 		-o shptreedump
 
 clean:
@@ -97,14 +99,17 @@
 	fi
 
 
-lib:	libshp.a
+lib:	libshp.la
 
-libshp.a:	$(LIBOBJ)
-	ar r libshp.a $(LIBOBJ)
+libshp.la:	$(LIBOBJ:%.o=%.lo)
+	libtool --mode=link $(CC) $(LDFLAGS) $(CFLAGS) -o libshp.la $(LIBOBJ:%.o=%.lo) -rpath $(libdir) -version-info 2:0:1
 
-lib_install:	libshp.a
-	cp libshp.a $(PREFIX)/lib
-	cp shapefil.h $(PREFIX)/include
+%.lo: %.c
+	libtool --mode=compile $(CC) -c $(CFLAGS) -o $@ $<
+
+lib_install:	libshp.la
+	libtool --mode=install install libshp.la $(DESTDIR)$(libdir)
+	cp shapefil.h $(DESTDIR)$(includedir)
 
 bin_install:	$(SHPBIN)
 	cp $(SHPBIN) $(PREFIX)/bin
